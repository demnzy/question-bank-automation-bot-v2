name: V2 Exam Transformation

on:
  repository_dispatch:
    types: [start-processing]

jobs:
  transform:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Download Files from n8n
        run: |
          # 1. Clean filename
          RAW_NAME="${{ github.event.client_payload.collection_name }}"
          SAFE_NAME=$(echo "$RAW_NAME" | sed 's/[^a-zA-Z0-9._-]//g')
          if [ -z "$SAFE_NAME" ]; then SAFE_NAME="Exam_Export"; fi
          
          echo "EXAM_NAME=$SAFE_NAME" >> $GITHUB_ENV
          
          # 2. Download Excel and PDF (PDF for future image mining)
          curl -L "${{ github.event.client_payload.excel_url }}" -o "${SAFE_NAME}.xlsx"
          curl -L "${{ github.event.client_payload.pdf_url }}" -o "${SAFE_NAME}.pdf"

      # --- PLACEHOLDER: IMAGE MINER (Enable later) ---
      # - name: Run Image Miner
      #   run: python image_miner_v2.py ...

      - name: Run V2 Transformer
        run: |
          # Define Output Name
          FINAL_NAME="${{ env.EXAM_NAME }}_Final.xlsx"
          
          # Run the Universal Miner
          python universal_miner.py \
            --input "${{ env.EXAM_NAME }}.xlsx" \
            --output "$FINAL_NAME" \
            --collection "${{ env.EXAM_NAME }}"
            
          echo "FINAL_FILE=$FINAL_NAME" >> $GITHUB_ENV

      - name: Send Result to n8n
        run: |
          echo "Uploading ${{ env.FINAL_FILE }} back to n8n..."
          
          # Force HTTPS to prevent redirect issues
          CALLBACK_URL="${{ github.event.client_payload.callback_url }}"
          
          curl -X POST "$CALLBACK_URL" \
          -H "Content-Type: multipart/form-data" \
          -F "data=@${{ env.FINAL_FILE }}" \
          -F "fileName=${{ env.FINAL_FILE }}" \
          -F "folder_id=${{ github.event.client_payload.folder_id }}" \
          -F "user_email=${{ github.event.client_payload.user_email }}"
