name: V2 Exam Transformation

on:
  repository_dispatch:
    types: [start-processing]

jobs:
  transform:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Download Input Excel
        run: |
          # Download the Enriched Excel from n8n payload
          echo "Downloading file from: ${{ github.event.client_payload.excel_url }}"
          curl -L "${{ github.event.client_payload.excel_url }}" -o input.xlsx

      - name: Run Universal Miner
        run: |
          # --- UPDATED TO USE YOUR NEW SCRIPT NAME ---
          python universal_miner.py --input input.xlsx --output output_v2.xlsx --collection "${{ github.event.client_payload.collection_name }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: transformed-v2-data
          path: output_v2.xlsx
          
      - name: Send Result to n8n
        run: |
          echo "Uploading output_v2.xlsx to n8n..."
          curl -X POST "${{ github.event.client_payload.callback_url }}" \
          -H "Content-Type: multipart/form-data" \
          -F "data=@output_v2.xlsx" \
          -F "folder_id=${{ github.event.client_payload.folder_id }}"
      # OPTIONAL: Add a step here to POST the result back to n8n if needed
      # - name: Notify n8n
      #   run: ...
